---
trigger: model_decision
description: when working on anything related to the backend
---

# Backend Tech Stack & Implementation Rules — PAU 2

## Purpose
Define the **backend-only** technology choices, architecture constraints, and quality gates.  
Frontend rules must live in `techstack-frontend.md`.

## Core Stack
- **Language:** Python 3.11+
- **Framework:** FastAPI
- **Database:** PostgreSQL
- **ORM:** SQLAlchemy
- **Migrations:** Alembic

## Architecture (Mandatory): Clean / Hexagonal
Backend code MUST follow these layers and dependency rules:

- `domain/`
  - entities, value objects, domain services
  - repository interfaces (ports)
  - **MUST NOT import** from application/infrastructure/presentation
- `application/` (or `use_cases/`)
  - use cases orchestration, transactional boundaries, policies
  - depends on `domain/` and repository interfaces
- `infrastructure/`
  - SQLAlchemy models, repository implementations, external adapters
  - depends on `application/` and `domain/`
- `presentation/`
  - FastAPI routers, request/response DTOs (Pydantic), error handlers, middleware wiring
  - depends on `application/` and `domain/` DTOs/contracts as needed (never on infrastructure internals)

### Forbidden Backend Patterns
- Business logic inside routers/controllers is forbidden (must live in use cases).
- Direct SQLAlchemy session usage inside `presentation/` is forbidden.
- Introducing a second ORM or a second migration system is forbidden.

## Project Structure (Canonical within `backend/`)
- `backend/alembic/` — migration scripts and configuration
- `backend/app/`
  - `application/`
  - `core/` — settings, logging, DB session factory, security utilities
  - `domain/`
  - `infrastructure/`
  - `presentation/`
  - `main.py` — FastAPI app creation, router mounting, middleware

Any structural change MUST be reflected in this file.

## API Standards
- **Style:** REST over JSON
- **Contract:** OpenAPI generated by FastAPI is canonical for endpoint definitions
- **DTOs:** Pydantic V2 schemas are mandatory at the boundary (request/response)
- **Validation:** input validation occurs at DTO layer; domain invariants enforced in `domain/`

## Database & Migrations Rules
- All schema changes MUST be represented as Alembic migrations committed to VCS.
- No manual schema edits in production environments.
- Migrations must be deterministic and reversible when feasible.

## Error Handling & Observability
- Centralized error mapping (domain/application exceptions -> HTTP responses) is mandatory.
- Logging must avoid leaking secrets or personal data.

## Quality & Tooling (Backend)
These are mandatory quality gates for backend changes:
- **Linting/formatting:** define and enforce a single toolchain (e.g., Ruff/Black) in CI
- **Testing:** pytest-based test suite
  - unit tests for domain/application
  - integration tests for repository + DB behavior
  - API tests for critical endpoints (auth, CRUD, exports)
- **Type checking:** consistent typing expectations (add type hints in application/domain)
- **Detailed Standards:** MUST follow constraints defined in `.agent/rules/backend-testing.md`.

### Coverage Thresholds (CI Gate)
- **Metrics:** Coverage will be reported for lines and branches.
- **Global Thresholds:** MUST be at least **90% lines** and **85% branches** coverage.
- **New/Modified Code:** MUST be at least **95% lines** and **90% branches** coverage.
- **Critical Modules:** MUST be at least **95% lines** and **90% branches** coverage.
- **Regression Policy:** No PR may reduce the global coverage percentage.
- **Exclusions:** All exclusions MUST be explicitly declared in configuration and reviewed.

Exact commands/scripts MUST be documented in `backend/` tooling docs or CI configuration and kept in sync with this file.

## Change Control
Any change to:
- the stack (framework, ORM, DB, migration tool),
- the layer rules,
- the backend folder structure,
MUST update this file in the same PR.
